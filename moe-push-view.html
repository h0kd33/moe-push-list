<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/iron-a11y-keys/iron-a11y-keys.html">

<link rel="import" href="bower_components/paper-styles/shadow.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/paper-input/paper-input.html">
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="bower_components/neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="bower_components/neon-animation/animations/slide-from-right-animation.html">
<link rel="import" href="bower_components/neon-animation/animations/fade-out-animation.html">

<link rel="import" href="moe-push-list.html">
<link rel="import" href="moe-emoji-selector.html">

<dom-module id="moe-push-view">
    <template>
        <style include="iron-flex iron-flex-alignment iron-positioning">
            :host {
                @apply(--layout-vertical);
                @apply(--layout-fixed-right);
                @apply(--shadow-elevation-16dp);

                display: none;
                max-width: 97vw;
                background-color: white;
            }

            #container {
                max-width: 650px;
                width: 100%;
                height: 100%;
            }

            #closeBar {
                cursor: pointer;
                width: 18px;
            }
            #closeBar:hover {
                background-color: #F8F8F8;
            }
            #closeBar:active {
                background-color: #EFEFEF;
            }
            #closeBar iron-icon {
                --iron-icon-width: 18px;
                --iron-icon-height: 18px;
                --iron-icon-fill-color: #AAA;
            }


            /**
            *   Input
            */
            paper-icon-button.giant {
                width: 40px;
                height: 40px;
                background-color: var(--paper-light-green-500);
                color: white;
                border-radius: 23px;
            }

            #input {
                padding: 5px 10px 5px 0;
            }
            #emojiSelectBtn{
                --paper-button: {
                    padding: 1em 0.3em ;
                    height: auto;
                    min-width: auto;
                    font-size: 13px;
                }
            }
            #emojiSelector {
                position: absolute;
                bottom: 72px;
                left: 0;
                right: 0;
            }
            .unselectable {
                -moz-user-select: none;
                -ms-user-select: none;
                -webkit-user-select: none;
                -webkit-touch-callout: none;
                user-select: none;
                -webkit-tap-highlight-color:  rgba(255, 255, 255, 0);
            }

        </style>

        <iron-a11y-keys id="a11y"
                        target="[[_enterTarget]]"
                        keys="enter"
                        on-keys-pressed="pushText">
        </iron-a11y-keys>

        <div id="container" class="layout horizontal flex" on-track="_handleTrack">
            <div id="closeBar" class="layout vertical center unselectable" on-tap="hide">
                <iron-icon icon="icons:chevron-right" class="flex"></iron-icon>
            </div>
            <div class="layout vertical flex">
                <!-- 閱讀區 -->
                <div id="scroller" class="layout vertical flex scroll">
                    <moe-push-list expand id="pushList" data="[[data]]" max-view="{{data.length}}"></moe-push-list>
                </div>
                <!--　輸入區　-->
                <div id="input" class="layout horizontal center relative">
                    <paper-button id="emojiSelectBtn" on-tap="_showEmojiSelector">{{selectedEmoji}}</paper-button>
                    <moe-emoji-selector id="emojiSelector" selected-emoji="{{selectedEmoji}}" hidden$="[[_emojiSelectorHide]]"></moe-emoji-selector>
                    <paper-input label="輸入推文" char-counter maxlength="60" class="flex" value="{{inputtingData::input}}"></paper-input>
                    <paper-icon-button class="giant" icon="icons:send" on-tap="pushText"></paper-icon-button>
                </div>
            </div>
        </div>

    </template>
    <script>
        (function () {
            'use strict';

            Polymer({

                is: 'moe-push-view',
                behaviors: [
                    Polymer.NeonAnimationRunnerBehavior
                ],
                properties: {
                    data: {
                        type: Array,
                        value: function () {
                            return [];
                        },
                        observer: '_dataChanged'
                    },
                    opened: {
                        type: Boolean
                    },
                    animationConfig: {
                        value: function () {
                            return {
                                'entry': {
                                    // provided by neon-animation/animations/scale-up-animation.html
                                    name: 'slide-from-right-animation',
                                    node: this
                                },
                                'exit': {
                                    // provided by neon-animation/animations/fade-out-animation.html
                                    name: 'fade-out-animation',
                                    node: this
                                }
                            }
                        }
                    },
                    inputtingData: String,

                    selectedEmoji: {
                        type: String,
                        value: '(^O^)'
                    },

                    _emojiSelectorHide: {
                        type: Boolean,
                        value: true
                    },
                    _enterTarget: {
                        type: Object,
                        value: function() {
                            return this.$.input;
                        }
                    }
                },
                listeners: {
                    'neon-animation-finish': '_onNeonAnimationFinish'
                },
                show: function () {
                    if(this.opened) return;
                    this.opened = true;
                    this.style.display = 'inline-block';
                    // run scale-up-animation
                    this.playAnimation('entry');
                },
                hide: function () {
                    if(!this.opened) return;
                    this.opened = false;
                    // run fade-out-animation
                    this.playAnimation('exit');
                },
                pushText: function () {
                    if (this.inputtingData.trim() === '') return;
                    var index = this.data[this.data.length - 1].index;
                    var push = {
                        index: index + 1,
                        id: '#######',
                        text: this.inputtingData,
                        time: '00:00:00',
                        date: '00/00/00'
                    };
                    this.push('data', push);
                    this.inputtingData = '';
                    this.$.scroller.scrollTop = this.$.pushList.offsetHeight;
                },
                _dataChanged: function (e) {
                },
                _handleTrack: function (e) {
                    try {
                        // 只能由　Touch event 觸發
                        if( (navigator.maxTouchPoints === 0) ||
                            (navigator.msMaxTouchPoints === 0)) error;
                        // 開啟時能觸發
                        if(this.opened === false)  error;
                        // 確認 root 是 <moe-push-view>
                        if(e.target.offsetParent.tagName !== 'MOE-PUSH-VIEW')  error;
                    } catch (err){ return }

                    var state = e.detail.state;
                    var dx = e.detail.dx;
                    var dy = e.detail.dy;
                    switch (true) {
                        case( state === 'start' ):
                            break;
                        case( state === 'track'):
                            break;
                        case( state === 'end' && dx > 60 && dy < 60 && dy > -60 ):
                            this.hide();
                            break;
                        default:
                            break;
                    }
                },
                _onNeonAnimationFinish: function () {
                    if (!this.opened) {
                        this.opend = false;
                        this.style.display = 'none';
                    }
                    this.opend = true;
                },
                _showEmojiSelector: function() {
                    this._emojiSelectorHide = this._emojiSelectorHide ? false : true ;
                }
            });

        })();
    </script>
</dom-module>
